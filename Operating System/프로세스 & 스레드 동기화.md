# 프로세스 & 스레드 동기화
### 목차
1. 동기화는 왜 필요할까?
2. 임계구역
3. 임계구역 문제 해결을 위한 기본조건
4. Semaphore
5. Mutex
6. 세마포와 뮤텍스의 차이점
<br><br><br>

## 동기화는 왜 필요할까?
프로세스는 서로 메세지를 보내고, 프로세스 내부에서는 스레드끼리 자원을 공유한다. 이 때, 어떠한 데이터에 대해 동시 작업이 일어났을 경우 데이터의 일관성이 깨지며 공유 자원을 신뢰할 수 없게 만든다. 따라서 처리 순서에 상관없이 원하는 결과값을 얻기 위해 동기화가 필요하다.
<br><br><br>

## 임계 구역 (Critical Section)
```
여러 프로세스(스레드) 가 자원을 공유하는 상황에서, 하나의 프로세스(스레드) 만 자원에 접근할 수 있도록 제한하는 영역이다.
```
따라서 이런 임계구역에서 발생하는 동기화 문제들을 해결해준다면, 올바른 동기화가 이루어질 수 있다.
<br><br><br>

## 임계구역 문제 해결을 위한 기본조건
- `상호 배제 (Mutual Exclusion)` : 하나의 프로세스가 임계구역에 들어가있다면, 다른 프로세스는 들어갈 수 없다.
- `진행 (Progress)` : 임계구역에서 실행중인 프로세스가 없고, 별도의 동작이 없는 프로세스들만 임계구역의 진입 후보로서 참여될 수 있다 (어떤 프로세스가 임계구역에 들어갈지 적절히 선택해줘야함)
- `한정된 대기 (Bounded Waiting)` : 기아 상태를 방지하기 위해, 한 번 들어갔다 나온 프로세스는 다음에 들어갈 때 제한을 준다.
<br><br><br><br>

## 세마포 (Semaphore)
**두 개의 원자적 함수로 조작되는 정적 변수**로써, 멀티 프로그래밍 환경에서 공유 자원(임계구역) 에 대한 접근을 제한하는 방법으로 사용된다. 세마포는 모든 교착상태를 해결하지는 못한다.
<br>

`세마포 변수 S` 는 정수값을 가지는 변수이며, P와 V라는 명령어에 의해서만 접근할 수 있다. `P`는 임계구역에 들어가기 전에 수행되고, `V`는 임계구역에서 나올 때 수행된다. 이 때, `세마포 변수 S` 를 수정하는 연산은 모두 원자성 을 만족해야 한다. 즉, 한 프로세스나 스레드에서 `세마포 변수 S` 값을 변경하는 동안에는 다른 프로세스나 스레드가 동시에 접근하여 변수값을 변경할 수 없다.
<br>

S 값이 0보다 크면 접근을 허용하되 1을 갑소시키고, S 값이 0이면 Block 시킨다. 반대로 작업이 끝나고 프로세스나 스레드가 임계구역에서 나갈때는 값을 1로 증가시켜 다른 프로세스나 스레드가 임계구역에 접근할 수 있도록 한다.
<br><br>

#### Busy Waiting
```Python
def P(s):
    while s <= 0:
    s -= 1

    # 임계구역 #

def V(s):
    s += 1
```
해당 방법은 임계구역에 진입하기 전 까지 반복문을 계속 수행하므로, 효율이 떨어지며 대기중인 프로세스 중 어느것을 먼저 임계구역에 진입시킬지 결정할 수 없다.
<br><br>

#### Queue
```Python
def P(s):
    s -= 1
    if s < 0:
        # block
        # 프로세스를 세마포 내부의 큐에 넣는다.

def V(s):
    s += 1
    if s <= 0:
        # wake up
        # 세마포 내부의 있는 큐에서 프로세스를 제거한 뒤 Ready Queue 로 보낸다.
```
Busy Waiting 의 단점을 활용한 방법으로, Queue 를 활용한다.
<br><br><br><br>

## 뮤텍스 (Mutex)
**이진 세마포**라고도 하며, Mutual Exclusion 에서 따온 이름으로 `상호배제` 의 의미를 가진다. 멀티 프로그래밍 환경에서 공유 불가능한 자원의 동시 사용을 막기 위해 사용되는 알고리즘으로, 일종의 Locking 알고리즘이다. lock 을 가진 프로세스(스레드) 만이 임계구역에 접근할 수 있다. 임계구역에서 작업이 끝난 프로세스(스레드) 는 Unlock 하여 lock 을 반환한다.
**공유 자원에 대한 해결책을 제시하지만, 멀티 프로그래밍 환경에서는 시간적인 효율성 측면에서 적용할 수 없다.**
<br><br>

#### 데커(Deckker) 알고리즘
`flag` 와 `turn` 변수를 통해 임계구역에 들어갈 프로세스(스레드) 를 결정하는 방식이다. `flag` 는 프로세스 중 누가 임계영역에 진입할 것인지를 나타내는 변수이고, `turn` 은 누가 임계구역에 들어갈 차례인지 나타내는 변수이다.
```python
while True:
    flag[i] = True          # i가 임계구역 진입 시도
    while flag[j]:          # j가 현재 임계구역에 있는지 확인
        if turn == j:       # j 가 임계구역 사용중이면
            flag[i] = False # i 진입취소
            while turn == j:# j 의 turn 이 끝날 때 까지 대기 
            flag[i] = True  # j 의 turn 이 끝나면 다시 진입 시도
        
        #----------- 임계구역 -----------#

turn = j        # 임계구역 사용 끝나면 turn 넘김
turn[i] = False # i 의 임계구역 사용 완료를 알림
```
<br><br>

#### 피터슨(Peterson) 알고리즘
데커 알고리즘과 유사하지만, 상대방 프로세스(스레드) 에게 진입 기회를 양보하는 것에 차이가 있다.
```Python
while True:
    flag[i] = True              # i 가 임계구역 진입 시도
    turn = j                    # 다른 프로세스에게 진입 기회 양보
    while flag[i] and turn == j:# 다른 프로세스가 진입 시도하면 대기

        #----------- 임계구역 -----------#

flag[i] = False # 임계구역 사용 완료를 알림
```
<br><br>

#### 제과점(Bakery) 알고리즘
여러 프로세스(스레드) 에 대한 처리가 가능한 알고리즘이다. 모든 프로세스(스레드) 에게 번호표를 부여하고, 가장 작은 수의 번호표를 가지고 있는 프로세스(스레드) 가 임계구역에 진입한다.
```Python
while True:
    isReady[i] = True # 번호표 받을 준비
    number[i] = max(number[0:n]) + 1 # 실행중인 프로세스 중에 가장 큰 번호 배정
    isReady[i] = False # 번호표 수령 완료

    for i in range(n):
        while isReady[j]: # 비교 프로세스 번호표 받을 때까지 대기
        while number[j] and number[j] < number[i] and j < i:
        # j 가 번호표를 가지고 있어야함
        # j 의 번호표 < i 의 번호표

        #----------- 임계구역 -----------#

number[i] = 0 # 임계구역 사용 종료
```
<br><br><br><br>


## Semaphore vs Mutex
뮤텍스는 이진 세마포이기 때문에, 세마포는 뮤텍스가 될 수 있지만, 뮤텍스는 세마포가 될 수 없다. 세마포는 소유할 수 없는 반면, 뮤텍스는 소유할 수 있고 소유자가 이에 책임을 진다. 뮤텍스는 동기화의 대상이 1개 뿐이지만, 세마포는 하나 이상의 동기화를 할 수 있다.
<br>

우리(프로세스) 가 방(임계구역) 에 들어가려고 할 때, Mutex 는 방에 들어가기 위한 열쇠의 개수이며, Semaphore 는 빈 방의 열쇠 개수이다. 
즉, Mutex 는 한 사람이 빈 방에 대한 열쇠를 가지고 있어서 방에 들어간다면, 그 사람이 나와야만 다른 사람이 열쇠를 건네받아 방에 들어갈 수 있다. 반면 Semaphore 는 방이 네 개면 열쇠도 네 개일 것이고, 한 사람이 들어갈 때마다 들어갈 수 있는 방은 하나씩 줄어들어 남아있는 방의 개수가 0개가 되면 빈 방이 나올때까지 대기해야 하는 상황이다. 아무나 먼저 나와야만 방과 열쇠를 한개씩 얻어서 들어갈 수 있다.